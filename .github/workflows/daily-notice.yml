name: Daily Message Sender

on:
  schedule:
    # 每天北京时间8点运行 (UTC 0点)
    - cron: '0 0 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Send Daily Message
      run: |
        # 获取当前时间（用于消息摘要）
        CURRENT_TIME=$(date '+%Y年%m月%d日 %H:%M:%S')
        echo "当前时间: $CURRENT_TIME"
        
        # 1. 获取最新的UID
        echo "正在获取最新的UID..."
        RESPONSE=$(curl -s "https://eob7gu4tu9r7a8s.m.pipedream.net")
        
        # 检查第一个API响应
        if echo "$RESPONSE" | jq -e '.code == 200' > /dev/null 2>&1; then
            LATEST_UID=$(echo "$RESPONSE" | jq -r '.data[0].uid')
            echo "获取到的UID: $LATEST_UID"
        else
            echo "第一个API调用失败"
            echo "响应内容: $RESPONSE"
            exit 1
        fi
        
        # 2. 获取一言内容
        echo "正在获取一言内容..."
        HITOKOTO_RESPONSE=$(curl -s "https://v1.hitokoto.cn/")
        
        # 检查第二个API响应
        if echo "$HITOKOTO_RESPONSE" | jq -e '.hitokoto' > /dev/null 2>&1; then
            HITOKOTO=$(echo "$HITOKOTO_RESPONSE" | jq -r '.hitokoto')
            FROM=$(echo "$HITOKOTO_RESPONSE" | jq -r '.from // "未知"')
            echo "获取到的一言: $HITOKOTO"
            echo "来源: $FROM"
        else
            echo "第二个API调用失败"
            echo "响应内容: $HITOKOTO_RESPONSE"
            exit 1
        fi
        
        # 3. 构造HTML内容
        HTML_CONTENT="<h1>$HITOKOTO</h1><br/>"
        HTML_CONTENT+="<p style='color: #666; font-size: 14px;'>—— $FROM</p><br/>"
        HTML_CONTENT+="<p style='color: #999; font-size: 12px;'>每日一言推送</p>"
        
        # 4. 构建发送消息的JSON数据
        MESSAGE_DATA=$(jq -n \
          --arg appToken "AT_C67vMtfIWhyGMKbm2jTTpkTY4OcaXHUP" \
          --arg content "$HTML_CONTENT" \
          --arg summary "$CURRENT_TIME" \
          --argjson contentType 2 \
          --arg uid "$LATEST_UID" \
          '{
            "appToken": $appToken,
            "content": $content,
            "summary": $summary,
            "contentType": $contentType,
            "uids": [$uid],
            "topicIds": [],
            "verifyPayType": 0
          }')
        
        echo "准备发送的消息数据:"
        echo "$MESSAGE_DATA" | jq .
        
        # 5. 发送消息
        echo "正在发送消息..."
        SEND_RESPONSE=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d "$MESSAGE_DATA")
        
        echo "发送结果:"
        echo "$SEND_RESPONSE" | jq .
        
        # 检查发送结果
        if echo "$SEND_RESPONSE" | jq -e '.code == 1000' > /dev/null 2>&1; then
            echo "✅ 消息发送成功！"
        else
            echo "❌ 消息发送失败"
            exit 1
        fi
      env:
        # 设置时区为亚洲/上海，确保时间正确
        TZ: Asia/Shanghai