# daily-message.yml
name: Daily Message Sender

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹è¿è¡Œ (UTC 0ç‚¹)
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    env:
      # è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·ï¼Œç¡®ä¿æ—¶é—´æ­£ç¡®
      TZ: Asia/Shanghai
      # ä» GitHub Secrets ä¸­è·å– AppToken
      WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
      # ä» GitHub Secrets ä¸­è·å–å’Œé£å¤©æ°”è®¤è¯ä¿¡æ¯
      HEFENG_PRIVATE_KEY: ${{ secrets.HEFENG_PRIVATE_KEY }}
      HEFENG_KEY_ID: ${{ secrets.HEFENG_KEY_ID }}
      HEFENG_PROJECT_ID: ${{ secrets.HEFENG_PROJECT_ID }}
      HEFENG_API_HOST: ${{ secrets.HEFENG_API_HOST || 'https://api.qweather.com' }}
      # åˆ¤æ–­æ˜¯å¦æ˜¯å®šæ—¶è§¦å‘
      IS_SCHEDULED: ${{ github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout repository with token
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install axios jose  # æ·»åŠ  jose åº“
        # qweather-icons æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸éœ€è¦å¯ä»¥ç§»é™¤
        # npm install qweather-icons
        npm install -g json  # å®‰è£… JSON å¤„ç†å·¥å…·

    - name: Store UID if scheduled
      if: env.IS_SCHEDULED == 'true'
      run: |
        echo "ğŸ•’ å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œæ­£åœ¨è·å–æœ€æ–°çš„UID..."
        
        # è·å–æœ€æ–°çš„UID
        UID_RESPONSE=$(curl -s "https://eob7gu4tu9r7a8s.m.pipedream.net")
        
        if echo "$UID_RESPONSE" | jq -e '.code == 200' > /dev/null 2>&1; then
          LATEST_UID=$(echo "$UID_RESPONSE" | jq -r '.data[0].uid')
          echo "è·å–åˆ°çš„UID: $LATEST_UID"
          
          # å­˜å‚¨ UID åˆ°æ–‡ä»¶
          mkdir -p data
          echo "{\"uid\": \"$LATEST_UID\", \"updated\": \"$(date '+%Y-%m-%d %H:%M:%S')\"}" > data/latest_uid.json
          
          # æäº¤ UID æ–‡ä»¶åˆ°ä»“åº“
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/latest_uid.json
          git commit -m "chore: update latest UID [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref }}
          
          echo "âœ… UID å·²å­˜å‚¨å¹¶æäº¤åˆ°ä»“åº“"
        else
          echo "âŒ UID APIè°ƒç”¨å¤±è´¥"
          echo "å“åº”å†…å®¹: $UID_RESPONSE"
          exit 1
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run daily message script
      run: |
        node scripts/send-message.js ${{ github.event_name == 'schedule' }}