# daily-message.yml
name: Daily Message Sender

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹è¿è¡Œ (UTC 0ç‚¹)
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    env:
      # è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·ï¼Œç¡®ä¿æ—¶é—´æ­£ç¡®
      TZ: Asia/Shanghai
      # ä» GitHub Secrets ä¸­è·å– AppToken
      WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
      # ä» GitHub Secrets ä¸­è·å–å’Œé£å¤©æ°”è®¤è¯ä¿¡æ¯
      HEFENG_PRIVATE_KEY: ${{ secrets.HEFENG_PRIVATE_KEY }}
      HEFENG_KEY_ID: ${{ secrets.HEFENG_KEY_ID }}
      HEFENG_PROJECT_ID: ${{ secrets.HEFENG_PROJECT_ID }}
      HEFENG_API_HOST: ${{ secrets.HEFENG_API_HOST }}
      # åˆ¤æ–­æ˜¯å¦æ˜¯å®šæ—¶è§¦å‘
      IS_SCHEDULED: ${{ github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        # é‡è¦ï¼šä½¿ç”¨å…·æœ‰å†™æƒé™çš„ token
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '24.5'

    - name: Install dependencies
      run: |
        npm install axios jose
        npm install -g json

    - name: Run daily message script
      run: |
        node scripts/send-message.js ${{ github.event_name == 'schedule' }}

    # æ–°å¢ï¼šæäº¤ data æ–‡ä»¶å¤¹çš„å˜æ›´åˆ° Git
    - name: Commit and push data files
      if: always()
      run: |
        echo "ğŸ“¦ æ£€æŸ¥ data æ–‡ä»¶å¤¹æ˜¯å¦æœ‰å˜æ›´..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git status --porcelain data/ | grep -q .; then
          echo "ğŸ”„ æ£€æµ‹åˆ° data æ–‡ä»¶å¤¹æœ‰å˜æ›´ï¼Œæäº¤åˆ° Git..."
          
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
          git add data/
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          if [ "${{ github.event_name }}" = "schedule" ]; then
            COMMIT_MSG="chore: update data files [è‡ªåŠ¨å®šæ—¶æ›´æ–°]"
          else
            COMMIT_MSG="chore: update data files [æ‰‹åŠ¨è§¦å‘æ›´æ–°]"
          fi
          
          # æäº¤
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°ä»“åº“..."
          git push origin HEAD:${{ github.ref }}
          
          echo "âœ… data æ–‡ä»¶å¤¹å˜æ›´å·²æäº¤åˆ°ä»“åº“"
        else
          echo "âœ… data æ–‡ä»¶å¤¹æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
        fi