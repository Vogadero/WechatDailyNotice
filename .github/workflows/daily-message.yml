# daily-message.yml
name: Daily Message Sender

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹è¿è¡Œ (UTC 0ç‚¹)
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    env:
      # è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·ï¼Œç¡®ä¿æ—¶é—´æ­£ç¡®
      TZ: Asia/Shanghai
      # åˆ¤æ–­æ˜¯å¦æ˜¯å®šæ—¶è§¦å‘
      IS_SCHEDULED: ${{ github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '24'

    - name: Install dependencies
      run: |
        npm install axios jose
        npm install -g json

    # æ–°å¢ï¼šè¯¦ç»†çš„ç¯å¢ƒå˜é‡è°ƒè¯•
    - name: Debug environment variables
      run: |
        echo "=== ç¯å¢ƒå˜é‡è°ƒè¯•å¼€å§‹ ==="
        echo ""
        
        # åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡
        echo "1. åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡:"
        printenv | sort | grep -E '(HEFENG|WXPUSHER|GITHUB)' || echo "æœªæ‰¾åˆ°ç›¸å…³ç¯å¢ƒå˜é‡"
        echo ""
        
        # æ£€æŸ¥ç‰¹å®šç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
        echo "2. æ£€æŸ¥ç‰¹å®šç¯å¢ƒå˜é‡:"
        for var in WXPUSHER_APP_TOKEN HEFENG_API_HOST HEFENG_KEY_ID HEFENG_PROJECT_ID; do
          if [ -n "${!var}" ]; then
            echo "   âœ… $var: å·²è®¾ç½® (é•¿åº¦: ${#!var})"
          else
            echo "   âŒ $var: æœªè®¾ç½®"
          fi
        done
        echo ""
        
        # æ£€æŸ¥ HEFENG_PRIVATE_KEY çš„ç‰¹æ®Šæƒ…å†µ
        echo "3. æ£€æŸ¥ HEFENG_PRIVATE_KEY:"
        if [ -n "$HEFENG_PRIVATE_KEY" ]; then
          echo "   âœ… HEFENG_PRIVATE_KEY: å·²è®¾ç½®"
          echo "       é•¿åº¦: ${#HEFENG_PRIVATE_KEY}"
          echo "       å‰50å­—ç¬¦: ${HEFENG_PRIVATE_KEY:0:50}..."
        else
          echo "   âŒ HEFENG_PRIVATE_KEY: æœªè®¾ç½®"
        fi
        echo ""
        
        # éªŒè¯ GitHub Secrets å¼•ç”¨
        echo "4. éªŒè¯ GitHub Secrets å¼•ç”¨:"
        echo "   IS_SCHEDULED: $IS_SCHEDULED"
        echo "   GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
        echo ""
        
        # æµ‹è¯•ç¯å¢ƒå˜é‡ä¼ é€’ç»™ Node.js
        echo "5. æµ‹è¯• Node.js ç¯å¢ƒå˜é‡:"
        node << 'EOF'
        console.log('Node.js ç¯å¢ƒå˜é‡æµ‹è¯•:');
        const envVars = ['WXPUSHER_APP_TOKEN', 'HEFENG_API_HOST', 'HEFENG_KEY_ID', 'HEFENG_PROJECT_ID', 'HEFENG_PRIVATE_KEY'];
        envVars.forEach(varName => {
          const value = process.env[varName];
          if (value) {
            console.log(`âœ… ${varName}: å·²è®¾ç½® (é•¿åº¦: ${value.length})`);
            if (varName === 'HEFENG_PRIVATE_KEY') {
              console.log(`   å¼€å§‹éƒ¨åˆ†: ${value.substring(0, 50)}...`);
            }
          } else {
            console.log(`âŒ ${varName}: æœªè®¾ç½®`);
          }
        });
        EOF
        echo ""
        echo "=== ç¯å¢ƒå˜é‡è°ƒè¯•ç»“æŸ ==="

    - name: Run daily message script
      env:
        # æ˜ç¡®åœ¨è¿™é‡Œå†æ¬¡è®¾ç½®ç¯å¢ƒå˜é‡
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
        HEFENG_API_HOST: ${{ secrets.HEFENG_API_HOST }}
        HEFENG_KEY_ID: ${{ secrets.HEFENG_KEY_ID }}
        HEFENG_PROJECT_ID: ${{ secrets.HEFENG_PROJECT_ID }}
        HEFENG_PRIVATE_KEY: ${{ secrets.HEFENG_PRIVATE_KEY }}
      run: |
        echo "=== è¿è¡Œä¸»è„šæœ¬ ==="
        echo "ä¼ é€’çš„ç¯å¢ƒå˜é‡:"
        echo "WXPUSHER_APP_TOKEN é•¿åº¦: ${#WXPUSHER_APP_TOKEN}"
        echo "HEFENG_API_HOST: ${HEFENG_API_HOST:0:30}..."
        echo "HEFENG_KEY_ID: $HEFENG_KEY_ID"
        echo "HEFENG_PROJECT_ID: $HEFENG_PROJECT_ID"
        echo "HEFENG_PRIVATE_KEY é•¿åº¦: ${#HEFENG_PRIVATE_KEY}"
        
        # è¿è¡Œè„šæœ¬ï¼Œå°† IS_SCHEDULED ä½œä¸ºå‚æ•°ä¼ é€’
        node scripts/send-message.js $IS_SCHEDULED

    # æäº¤ data æ–‡ä»¶å¤¹çš„å˜æ›´åˆ° Git
    - name: Commit and push data files
      if: always()
      run: |
        echo "ğŸ“¦ æ£€æŸ¥ data æ–‡ä»¶å¤¹æ˜¯å¦æœ‰å˜æ›´..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git status --porcelain data/ | grep -q .; then
          echo "ğŸ”„ æ£€æµ‹åˆ° data æ–‡ä»¶å¤¹æœ‰å˜æ›´ï¼Œæäº¤åˆ° Git..."
          
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
          git add data/
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          if [ "$IS_SCHEDULED" = "true" ]; then
            COMMIT_MSG="chore: update data files [è‡ªåŠ¨å®šæ—¶æ›´æ–°]"
          else
            COMMIT_MSG="chore: update data files [æ‰‹åŠ¨è§¦å‘æ›´æ–°]"
          fi
          
          # æäº¤
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°ä»“åº“..."
          git push origin HEAD:${{ github.ref }}
          
          echo "âœ… data æ–‡ä»¶å¤¹å˜æ›´å·²æäº¤åˆ°ä»“åº“"
        else
          echo "âœ… data æ–‡ä»¶å¤¹æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
        fi