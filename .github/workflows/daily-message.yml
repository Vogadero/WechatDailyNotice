# daily-message.yml
name: Daily Message Sender

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹è¿è¡Œ (UTC 0ç‚¹)
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  send-message:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦è¿™ä¸ªæƒé™æ¥æ¨é€æ›´æ”¹
      actions: read
      checks: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '24'

    - name: Install dependencies
      run: |
        npm install axios jose
        npm install -g json

    # ç¯å¢ƒå˜é‡æµ‹è¯•æ­¥éª¤
    - name: Test environment variables
      env:
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
        HEFENG_API_HOST: ${{ secrets.HEFENG_API_HOST }}
        HEFENG_KEY_ID: ${{ secrets.HEFENG_KEY_ID }}
        HEFENG_PROJECT_ID: ${{ secrets.HEFENG_PROJECT_ID }}
        HEFENG_PRIVATE_KEY: ${{ secrets.HEFENG_PRIVATE_KEY }}
      run: |
        echo "=== æµ‹è¯•ç¯å¢ƒå˜é‡ ==="
        echo ""
        
        # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®
        test_vars=(
          "WXPUSHER_APP_TOKEN"
          "HEFENG_API_HOST"
          "HEFENG_KEY_ID"
          "HEFENG_PROJECT_ID"
          "HEFENG_PRIVATE_KEY"
        )
        
        all_set=true
        for var in "${test_vars[@]}"; do
          if [ -n "${!var}" ]; then
            echo "âœ… $var: å·²è®¾ç½®"
            # æ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿæ•°æ®ï¼‰
            if [ "$var" = "HEFENG_PRIVATE_KEY" ]; then
              echo "   é•¿åº¦: ${#!var}"
            fi
          else
            echo "âŒ $var: æœªè®¾ç½®"
            all_set=false
          fi
        done
        
        echo ""
        if [ "$all_set" = true ]; then
          echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®"
        else
          echo "âŒ éƒ¨åˆ†ç¯å¢ƒå˜é‡æœªè®¾ç½®"
          echo "è¯·æ£€æŸ¥ GitHub Secrets æ˜¯å¦å·²æ­£ç¡®è®¾ç½®"
          exit 1
        fi

    - name: Run daily message script
      env:
        # åœ¨è¿™é‡Œä¼ é€’æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
        HEFENG_API_HOST: ${{ secrets.HEFENG_API_HOST }}
        HEFENG_KEY_ID: ${{ secrets.HEFENG_KEY_ID }}
        HEFENG_PROJECT_ID: ${{ secrets.HEFENG_PROJECT_ID }}
        HEFENG_PRIVATE_KEY: ${{ secrets.HEFENG_PRIVATE_KEY }}
        # åˆ¤æ–­æ˜¯å¦æ˜¯å®šæ—¶è§¦å‘
        IS_SCHEDULED: ${{ github.event_name == 'schedule' }}
      run: |
        echo "=== è¿è¡Œä¸»è„šæœ¬ ==="
        echo "ä¼ é€’çš„ç¯å¢ƒå˜é‡:"
        echo "WXPUSHER_APP_TOKEN é•¿åº¦: ${#WXPUSHER_APP_TOKEN}"
        echo "HEFENG_API_HOST: $HEFENG_API_HOST"
        echo "HEFENG_KEY_ID: $HEFENG_KEY_ID"
        echo "HEFENG_PROJECT_ID: $HEFENG_PROJECT_ID"
        echo "HEFENG_PRIVATE_KEY é•¿åº¦: ${#HEFENG_PRIVATE_KEY}"
        echo "IS_SCHEDULED: $IS_SCHEDULED"
        
        # è¿è¡Œè„šæœ¬
        node scripts/send-message.js $IS_SCHEDULED

    # æäº¤ data æ–‡ä»¶å¤¹çš„å˜æ›´åˆ° Git
    - name: Commit and push data files
      if: always()
      env:
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        echo "ğŸ“¦ æ£€æŸ¥ data æ–‡ä»¶å¤¹æ˜¯å¦æœ‰å˜æ›´..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git status --porcelain data/ | grep -q .; then
          echo "ğŸ”„ æ£€æµ‹åˆ° data æ–‡ä»¶å¤¹æœ‰å˜æ›´ï¼Œæäº¤åˆ° Git..."
          
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # è®¾ç½®è¿œç¨‹ URL ä½¿ç”¨ token
          git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}
          
          # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
          git add data/
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          if [ "${{ github.event_name }}" = "schedule" ]; then
            COMMIT_MSG="chore: update data files [è‡ªåŠ¨å®šæ—¶æ›´æ–°]"
          else
            COMMIT_MSG="chore: update data files [æ‰‹åŠ¨è§¦å‘æ›´æ–°]"
          fi
          
          # æäº¤
          git commit -m "$COMMIT_MSG" || echo "æäº¤å¤±è´¥æˆ–æ— å˜æ›´"
          
          # æ¨é€
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°ä»“åº“..."
          git push origin HEAD:${{ github.ref }} || echo "æ¨é€å¤±è´¥"
          
          echo "âœ… data æ–‡ä»¶å¤¹å˜æ›´å°è¯•æäº¤å®Œæˆ"
        else
          echo "âœ… data æ–‡ä»¶å¤¹æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
        fi